---
import { getTranslations, getLocalizedValue, type Locale } from '../../i18n';
import type { Specialist, Service } from '../../types/specialist';
import {
  getServiceVariants,
  getServiceMinPrice,
  getServiceMaxPrice,
  hasMultipleVariants,
  getServiceMinDuration,
} from '../../utils/specialists';

interface Props {
  specialist: Specialist;
  locale: Locale;
}

const { specialist, locale } = Astro.props;
const t = getTranslations(locale);

const featuredServices = specialist.services.filter(s => s.featured).slice(0, 2);
const isMassageWellness = specialist.id === 'massage-wellness';

const colorClasses = isMassageWellness
  ? {
      gradient: 'from-amber-50 to-white',
      border: 'border-amber-100',
      badge: 'text-amber-700 bg-amber-100',
      price: 'text-amber-600',
      link: 'text-amber-600 hover:text-amber-700',
      variantBg: 'bg-amber-50',
    }
  : {
      gradient: 'from-purple-50 to-white',
      border: 'border-purple-100',
      badge: 'text-purple-700 bg-purple-100',
      price: 'text-purple-600',
      link: 'text-purple-600 hover:text-purple-700',
      variantBg: 'bg-purple-50',
    };

const formatPrice = (service: Service) => {
  const minPrice = getServiceMinPrice(service);
  const maxPrice = getServiceMaxPrice(service);
  if (minPrice === maxPrice) {
    return `${service.currency} ${minPrice}`;
  }
  return `${t.services.from || 'ab'} ${service.currency} ${minPrice}`;
};

const formatDuration = (service: Service) => {
  const variants = getServiceVariants(service);
  if (variants.length === 1) {
    return `${variants[0].duration} ${t.services.minutes}`;
  }
  const durations = variants.map(v => v.duration);
  return `${Math.min(...durations)}-${Math.max(...durations)} ${t.services.minutes}`;
};
---

<div class={isMassageWellness ? 'mb-16' : ''}>
  <div class="flex items-center justify-between mb-8">
    <h3 class="text-2xl font-display font-semibold text-gray-900">
      {getLocalizedValue(specialist.name, locale)}
    </h3>
    <a
      href={`/${specialist.slug}`}
      class={`${colorClasses.link} font-medium text-sm flex items-center gap-1 transition-colors`}
    >
      {t.services.viewAll}
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {featuredServices.map((service) => {
      const variants = getServiceVariants(service);
      const hasVariants = hasMultipleVariants(service);
      const extras = service.extras || [];

      return (
        <div class={`group p-6 bg-gradient-to-br ${colorClasses.gradient} rounded-2xl border ${colorClasses.border} hover:shadow-lg transition-all`}>
          <div class="flex justify-between items-start mb-4">
            <div>
              <span class={`inline-block px-2 py-1 text-xs font-medium ${colorClasses.badge} rounded-full mb-2`}>
                {t.services.featured}
              </span>
              <h4 class="text-lg font-semibold text-gray-900">
                {getLocalizedValue(service.name, locale)}
              </h4>
            </div>
            <span class={`text-lg font-bold ${colorClasses.price}`}>
              {formatPrice(service)}
            </span>
          </div>
          <p class="text-gray-600 text-sm mb-4">
            {getLocalizedValue(service.description, locale)}
          </p>

          {/* Variant pills for services with multiple options */}
          {hasVariants && (
            <div class={`flex flex-wrap gap-2 mb-4 p-2 rounded-lg ${colorClasses.variantBg}`}>
              {variants.map((variant) => (
                <span class="px-2 py-1 text-xs rounded bg-white text-gray-700">
                  {variant.duration} {t.services.minutes}: {service.currency} {variant.price}
                </span>
              ))}
            </div>
          )}

          {/* Extras preview */}
          {extras.length > 0 && (
            <div class="mb-4">
              <span class="text-xs text-gray-500">{t.services.extras || 'Extras'}: </span>
              <span class="text-xs text-gray-600">
                {extras.slice(0, 3).map((e) => `+${getLocalizedValue(e.name, locale)}`).join(', ')}
                {extras.length > 3 && ` +${extras.length - 3}`}
              </span>
            </div>
          )}

          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-500">
              {formatDuration(service)}
            </span>
            <a
              href={`https://wa.me/${specialist.contact.whatsapp.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(t.whatsapp.greetingWithService.replace('{service}', getLocalizedValue(service.name, locale)))}`}
              target="_blank"
              rel="noopener noreferrer"
              class={`inline-flex items-center gap-1 text-sm font-medium ${colorClasses.link} transition-colors`}
            >
              {t.services.bookNow}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </a>
          </div>
        </div>
      );
    })}
  </div>
</div>
